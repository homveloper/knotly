목표: 모바일, 태블릿, 데스크톱에서 일관된 UX를 제공하고, 도형 타입(동그라미, 네모, 다이아몬드, 구름), 색상(8가지), 선 스타일(실선, 점선, 곡선), 화살표(없음, 단방향, 양방향)를 추가하여 표현력을 확장한다. 반응형 디자인으로 화면 크기에 따라 UI를 자동 조정하며, 터치 타겟을 44x44px 이상으로 설정하여 모바일 접근성을 보장한다.

핵심 기능: 도형 타입 선택. FAB 버튼을 500ms 롱프레스하면 도형 선택 메뉴가 나타난다. 메뉴는 FAB 버튼 위에 플로팅되며, 동그라미, 네모, 다이아몬드, 구름 4가지 아이콘을 수평으로 배치한다. 사용자가 아이콘을 탭하면 선택한 도형 타입으로 노드가 생성된다. 기존 노드를 롱프레스하면 컨텍스트 메뉴에 "도형 변경" 옵션이 나타나고, 선택 시 도형 타입이 변경된다. 도형은 rough.js로 렌더링한다. 동그라미는 rc.circle, 네모는 rc.rectangle, 다이아몬드는 rc.polygon(중심 좌표를 기준으로 4개 점 계산), 구름은 rc.ellipse 3개를 겹쳐서 그린다. 색상 팔레트 확장. Milestone 2에서 3가지였던 색상을 8가지로 확장한다. 노란색(#FFE082), 하늘색(#90CAF9), 민트(#A5D6A7), 핑크(#F48FB1), 보라(#CE93D8), 주황(#FFAB91), 연두(#C5E1A5), 회색(#E0E0E0)를 제공한다. 노드 컨텍스트 메뉴에서 "색상 변경"을 선택하면 색상 팔레트가 하단 시트로 표시된다. 8개 색상을 2행 4열 그리드로 배치하고, 현재 선택된 색상에 체크마크를 표시한다. 색상을 탭하면 즉시 노드 배경색이 변경되고, gRPC UpdateNode RPC를 호출하여 서버에 동기화한다. 선 스타일 다양화. 연결 모드 버튼을 탭하면 하단에 선 스타일 메뉴가 표시된다. 스타일은 실선(strokeLineDash 없음), 점선(strokeLineDash [5, 5]), 곡선(베지어 곡선)을 제공한다. 화살표는 없음, 단방향, 양방향을 선택할 수 있다. 단방향은 도착 노드 쪽에 화살표를 그리고, 양방향은 양쪽에 화살표를 그린다. 화살표는 SVG marker 요소로 정의하고, line 또는 path의 marker-end, marker-start 속성으로 적용한다. 곡선은 베지어 곡선을 사용하여 출발점과 도착점 사이에 제어점 2개를 자동 계산한다. 제어점은 출발점에서 도착점으로 향하는 벡터의 1/3 지점과 2/3 지점을 사용한다. rough.js의 curve 메서드로 렌더링한다. 반응형 레이아웃. Tailwind CSS의 브레이크포인트를 사용하여 화면 크기에 따라 UI를 조정한다. 모바일(< 768px)에서는 FAB 메뉴를 하단 시트로 표시하고, 사이드바를 숨긴다. 태블릿(768px - 1024px)에서는 사이드바를 토글 가능하게 하고, 햄버거 메뉴 버튼을 추가한다. 데스크톱(> 1024px)에서는 사이드바를 항상 표시한다. 소프트 키보드 대응. iOS와 Android에서 소프트 키보드가 올라올 때 viewport height가 줄어든다. window.visualViewport.height를 사용하여 실제 보이는 영역을 계산하고, 편집 중인 노드가 가려지면 캔버스를 자동으로 스크롤한다. window.addEventListener('resize')로 키보드 상태 변화를 감지한다.

입출력 명세: 도형 타입 입력. 사용자가 FAB 버튼을 500ms 롱프레스하면 onLongPress 이벤트가 발생한다. react-use-gesture의 useLongPress 훅을 사용하여 감지한다. 도형 선택 메뉴를 표시하고, 사용자가 동그라미 아이콘을 탭하면 createNode({type: 'circle'})을 호출한다. 네모는 {type: 'rectangle'}, 다이아몬드는 {type: 'diamond'}, 구름은 {type: 'cloud'}를 전달한다. 기존 노드 도형 변경 시 updateNode(nodeId, {type: newType})을 호출한다. 색상 선택 입력. 색상 팔레트에서 색상을 탭하면 onClick 핸들러가 실행된다. updateNode(nodeId, {style: {backgroundColor: selectedColor}})를 호출한다. gRPC UpdateNode RPC로 서버에 전송한다. 선 스타일 입력. 연결 모드에서 스타일을 선택하면 Zustand 스토어의 selectedLineStyle 상태를 업데이트한다. set({selectedLineStyle: 'solid' | 'dashed' | 'curved'})를 실행한다. 화살표 선택 시 selectedArrowType: 'none' | 'single' | 'double'을 업데이트한다. 두 노드를 탭하여 연결하면 createEdge({fromId, toId, lineStyle: selectedLineStyle, arrowType: selectedArrowType})을 호출한다. 반응형 레이아웃 출력. window.innerWidth를 useEffect에서 감지하고, isMobile, isTablet, isDesktop 상태를 계산한다. const isMobile = window.innerWidth < 768; const isTablet = window.innerWidth >= 768 && window.innerWidth < 1024; const isDesktop = window.innerWidth >= 1024로 계산한다. {isMobile && <BottomSheet />} {isDesktop && <Sidebar />}처럼 조건부 렌더링한다. 소프트 키보드 감지 출력. window.visualViewport.addEventListener('resize', handleResize)로 이벤트를 등록한다. const viewportHeight = window.visualViewport.height를 가져온다. const keyboardHeight = window.innerHeight - viewportHeight를 계산한다. keyboardHeight > 100이면 키보드가 올라온 것으로 판단한다. 편집 중인 노드의 position.y + keyboardHeight > viewportHeight이면 노드가 가려진 것이다. useCanvasStore.getState().setPan({y: pan.y - (노드 위치 - 뷰포트 중앙)})로 스크롤한다.

데이터 구조: 노드 타입이 확장된다. {id: UUID, position: {x, y}, content: string, type: 'circle' | 'rectangle' | 'diamond' | 'cloud', style: {backgroundColor: string, strokeColor: string, strokeWidth: number}, createdAt: timestamp, updatedAt: timestamp}로 정의한다. 엣지 타입이 확장된다. {id: UUID, fromId: UUID, toId: UUID, lineStyle: 'solid' | 'dashed' | 'curved', arrowType: 'none' | 'single' | 'double', createdAt: timestamp}로 정의한다. Zustand 스토어에 추가 상태를 정의한다. selectedShapeType: 'circle' | 'rectangle' | 'diamond' | 'cloud'를 추가한다. 기본값은 'circle'이다. selectedLineStyle: 'solid' | 'dashed' | 'curved'를 추가한다. 기본값은 'dashed'이다. selectedArrowType: 'none' | 'single' | 'double'를 추가한다. 기본값은 'none'이다. isMobile, isTablet, isDesktop: boolean 상태를 추가한다. shapeMenuOpen: boolean 상태를 추가하여 도형 선택 메뉴의 표시 여부를 관리한다. 색상 팔레트는 상수 배열로 정의한다. const COLORS = [{name: '노란색', value: '#FFE082'}, {name: '하늘색', value: '#90CAF9'}, {name: '민트', value: '#A5D6A7'}, {name: '핑크', value: '#F48FB1'}, {name: '보라', value: '#CE93D8'}, {name: '주황', value: '#FFAB91'}, {name: '연두', value: '#C5E1A5'}, {name: '회색', value: '#E0E0E0'}]로 작성한다.

기능적 제약사항: 도형은 4가지만 지원한다. 커스텀 도형 그리기는 Phase 2 실험 기능으로 연기한다. 색상은 8가지만 지원한다. 그라디언트, 투명도 조절은 Phase 2로 연기한다. 선 스타일은 3가지만 지원한다. 선 두께 조절은 Phase 2로 연기한다. 화살표는 3가지 옵션만 지원한다. 커스텀 화살표 모양은 Phase 2로 연기한다. 텍스트 서식(볼드, 이탤릭, 밑줄)은 지원하지 않는다. Phase 2에서 Rich Text Editor를 도입할 때 추가한다. PWA 오프라인 모드는 선택 사항이다. 시간이 남으면 Service Worker를 추가하여 구현하지만, 우선순위는 낮다. 도형 변경 시 노드 크기가 자동으로 조정되지 않는다. 기존 크기를 유지하므로 사용자가 필요 시 수동으로 조정해야 한다. 곡선 제어점은 자동 계산된다. 사용자가 직접 제어점을 드래그하여 조정하는 기능은 Phase 2로 연기한다.

기술적 제약: rough.js는 베지어 곡선을 curve 메서드로 지원한다. curve([[x1, y1], [cx1, cy1], [cx2, cy2], [x2, y2]], options)로 호출한다. 제어점 계산은 const dx = (x2 - x1) / 3; const dy = (y2 - y1) / 3; const cx1 = x1 + dx; const cy1 = y1 + dy; const cx2 = x1 + 2 * dx; const cy2 = y1 + 2 * dy로 수행한다. SVG marker는 defs 요소 내부에 정의한다. <defs><marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#000" /></marker></defs>로 작성한다. line 또는 path에 marker-end="url(#arrowhead)"를 추가하여 적용한다. 양방향 화살표는 marker-start="url(#arrowhead-reverse)" marker-end="url(#arrowhead)"를 모두 추가한다. Tailwind CSS의 브레이크포인트는 sm:, md:, lg:, xl:을 사용한다. sm은 640px, md는 768px, lg는 1024px, xl은 1280px이다. 커스텀 브레이크포인트를 사용하려면 tailwind.config.js의 theme.screens를 수정한다. screens: {mobile: '0px', tablet: '768px', desktop: '1024px'}로 정의한다. 소프트 키보드 감지는 iOS와 Android에서 동작이 다르다. iOS는 window.visualViewport.height가 변경되지만, Android 일부 브라우저는 window.innerHeight가 변경된다. 양쪽을 모두 감지하려면 window.addEventListener('resize')와 visualViewport.addEventListener('resize')를 모두 등록한다. 다이아몬드 도형은 4개 점의 polygon으로 그린다. const points = [[x, y - size / 2], [x + size / 2, y], [x, y + size / 2], [x - size / 2, y]]로 계산한다. rc.polygon(points, options)로 렌더링한다. 구름 도형은 3개의 ellipse를 겹쳐서 그린다. rc.ellipse(x - 30, y, 60, 50); rc.ellipse(x + 30, y, 60, 50); rc.ellipse(x, y - 20, 80, 40)처럼 위치를 조정하여 구름 모양을 만든다.

의존성: Milestone 2의 CRUD 기능이 완료되어 있어야 한다. createNode, updateNode 액션을 확장하여 type 파라미터를 추가한다. Milestone 3의 gRPC 통신이 구현되어 있어야 한다. Protobuf 스키마에 type, lineStyle, arrowType 필드를 추가한다. message Node에 string type = 5를 추가한다. message Edge에 string line_style = 4, string arrow_type = 5를 추가한다. Tailwind CSS가 설정되어 있어야 한다. 반응형 유틸리티 클래스를 사용한다. react-use-gesture가 설치되어 있어야 한다. useLongPress 훅으로 롱프레스를 감지한다.

완료 조건: 브라우저에서 FAB 버튼을 500ms 롱프레스하면 도형 선택 메뉴가 나타난다. 동그라미, 네모, 다이아몬드, 구름 4가지 아이콘이 표시된다. 네모 아이콘을 탭하면 네모 노드가 생성된다. 노드를 롱프레스하면 컨텍스트 메뉴에 "도형 변경" 옵션이 나타난다. 선택 시 도형이 변경된다. 노드 컨텍스트 메뉴에서 "색상 변경"을 선택하면 8가지 색상 팔레트가 표시된다. 핑크를 탭하면 노드 배경이 핑크로 변경된다. 연결 모드 버튼을 탭하면 하단에 선 스타일 메뉴가 나타난다. 곡선을 선택하고 단방향 화살표를 선택한다. 두 노드를 순차적으로 탭하면 곡선 화살표가 생성된다. 화살표는 도착 노드 쪽에만 표시된다. 브라우저 너비를 360px로 조정하면 FAB 메뉴가 하단 시트로 표시된다. 너비를 1920px로 조정하면 사이드바가 항상 표시된다. iPhone Safari에서 노드를 편집하고 키보드가 올라오면 노드가 자동으로 스크롤되어 가려지지 않는다. 모든 터치 타겟이 44x44px 이상이다.

성공 지표: 사용자 10명에게 모바일에서 4가지 도형을 모두 사용하여 노드 10개를 만들고 3가지 선 스타일로 연결하는 테스트를 수행한다. 평균 완료 시간이 5분 이내이고, "모바일에서 편하다"는 피드백이 80% 이상이면 성공이다. 360px 너비 화면에서 60fps를 유지하고, 터치 타겟이 44x44px 이상이며, 레이아웃 전환이 100ms 이내이면 성공이다. "도형이 다양하다", "선 스타일이 유용하다"는 피드백이 70% 이상이면 성공이다.
