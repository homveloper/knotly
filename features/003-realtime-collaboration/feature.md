# Milestone 3: 실시간 협업

## 📋 마일스톤 개요

**기간**: Week 7-10 (4주)
**목표**: 서버 주도 operation ordering + gRPC Server Streaming 기반 실시간 동기화 + 커서 위치 공유로 계정 없는 실시간 협업 환경을 구현합니다.

## 💡 비즈니스 가치

### 왜 이 기능이 필요한가?

Milestone 2에서 로컬 노트 편집 기능을 완성했다면, 이제 **여러 사용자가 동시에 편집**할 수 있어야 합니다. Knotly의 핵심 가치는 "즉시 협업"입니다. 계정 생성 없이 URL만 공유하면 바로 함께 작업할 수 있는 Google Docs 스타일의 협업 경험을 제공합니다.

### 서버 주도 방식의 장점

CRDT나 OT의 복잡한 수학적 병합 알고리즘 대신, **서버가 operation 순서를 결정**하는 단순한 방식을 채택합니다. Matt Weidner의 "Text Without CRDTs" 논문에서 영감을 받아, 충돌 해결을 서버의 간단한 비즈니스 로직으로 처리합니다. 이는 구현이 단순하면서도 실시간 협업에 충분합니다.

### 계정 없는 협업의 마찰 제거

회원가입, 로그인, 이메일 인증 등의 과정 없이 브라우저에서 바로 접속하여 협업을 시작할 수 있습니다. 브라우저 세션 ID 또는 임시 닉네임으로 사용자를 식별하며, 이는 Excalidraw나 Figma FigJam과 같은 성공적인 협업 도구들의 전략입니다.

### 이벤트 소싱의 학습 가치

모든 operation을 PostgreSQL에 기록하여 완벽한 히스토리 추적을 제공합니다. 다만 영속성 레이어 폭발을 방지하기 위해 매일 자정 스냅샷을 생성하고 7일 이전 이벤트는 자동 삭제하는 하이브리드 전략을 사용합니다. 이는 포트폴리오용 학습 목적으로도 훌륭한 경험입니다.

## 📖 사용자 스토리

### Story 1: 즉시 협업 시작
```
As a 팀 리더
I want to URL만 공유하면 팀원들이 즉시 협업을 시작할 수 있도록
So that 회의 중에 바로 아이디어를 함께 정리할 수 있다
```

**수용 기준**:
- 브라우저에서 워크스페이스 URL 접속 시 즉시 캔버스가 로드된다
- 계정 생성 없이 임시 닉네임을 설정하거나 "익명 사용자 1234"로 표시된다
- 다른 사용자가 추가한 노드가 실시간으로 내 화면에 나타난다

### Story 2: 동시 편집 충돌 해결
```
As a 사용자
I want to 다른 사용자와 동시에 같은 노드를 편집해도 충돌 없이
So that 혼란 없이 협업할 수 있다
```

**수용 기준**:
- 동일 노드를 두 사용자가 동시에 이동하면 마지막 timestamp가 우선한다
- 삭제된 노드를 수정하려는 시도는 자동으로 무시되고 알림이 표시된다
- 서버 응답 실패 시 로컬 상태가 롤백되고 사용자에게 알림이 표시된다

### Story 3: 커서 위치 공유
```
As a 사용자
I want to 다른 사용자의 마우스 커서 위치를 보면서
So that 누가 어디를 작업 중인지 파악할 수 있다
```

**수용 기준**:
- 다른 사용자의 커서가 반투명 원과 닉네임으로 표시된다
- 커서 위치는 100ms 쓰로틀링으로 전송되어 네트워크 부하를 줄인다
- 5초간 움직임이 없으면 커서가 페이드아웃된다

### Story 4: Optimistic UI
```
As a 사용자
I want to 노드를 드래그하면 즉시 화면에 반영되고
So that 부드러운 사용 경험을 느낄 수 있다
```

**수용 기준**:
- 노드 이동 시 즉시 로컬 상태가 업데이트된다
- 동시에 서버에 gRPC Unary RPC로 요청을 전송한다
- 500ms 디바운싱을 적용하여 드래그 중에는 요청을 보내지 않는다
- 드래그가 끝난 후 최종 위치만 전송한다

### Story 5: 이벤트 히스토리
```
As a 개발자
I want to 모든 operation이 서버에 기록되어
So that 나중에 Time Travel 기능(Phase 2)을 구현할 수 있다
```

**수용 기준**:
- 모든 operation이 workspace_events 테이블에 저장된다
- sequence number, timestamp, session_id가 함께 기록된다
- 매일 자정 스냅샷이 생성되고 7일 이전 이벤트는 삭제된다

## ✅ 성공 지표

### 완료 조건
- [ ] 브라우저 세션 ID 또는 임시 닉네임으로 사용자 식별이 가능하다
- [ ] gRPC Unary RPC로 노드 CRUD 요청을 보낼 수 있다
- [ ] gRPC Server Streaming RPC로 실시간 업데이트를 수신할 수 있다
- [ ] 서버가 모든 operation에 sequence number를 부여한다
- [ ] 동시 이동 시 Last Write Wins 규칙이 적용된다
- [ ] 삭제된 노드 수정 시 서버에서 무시하고 클라이언트에 실패 응답을 보낸다
- [ ] Optimistic UI가 작동하여 즉시 로컬 상태가 업데이트된다
- [ ] 500ms 디바운싱과 100ms 커서 쓰로틀링이 적용된다
- [ ] 모든 operation이 PostgreSQL workspace_events 테이블에 저장된다
- [ ] 매일 자정 스냅샷이 생성되고 7일 이전 이벤트가 삭제된다

### 데모 시나리오
1. 사용자 A가 브라우저에서 워크스페이스 접속
2. 임시 닉네임 "철수"로 설정
3. 노드 1개 생성: "프로젝트 아이디어"
4. 사용자 B가 동일 워크스페이스 URL 접속
5. 임시 닉네임 "영희"로 설정
6. 사용자 A가 만든 노드가 사용자 B 화면에 즉시 표시됨
7. 사용자 B가 새 노드 생성: "마케팅 전략"
8. 사용자 A 화면에 즉시 표시됨
9. 사용자 A와 B가 동시에 "프로젝트 아이디어" 노드를 이동
10. 서버가 마지막 timestamp를 가진 operation을 적용
11. 두 사용자 모두 동일한 최종 위치를 본다
12. 사용자 A의 커서가 사용자 B 화면에 표시됨
13. 사용자 B가 노드를 삭제하면 사용자 A 화면에서도 즉시 삭제됨

## 🎨 UI/UX 요구사항

### 사용자 식별 UI
- **임시 닉네임 설정**: 첫 접속 시 모달로 닉네임 입력 (선택사항)
- **미설정 시**: "익명 사용자 1234" (무작위 번호 4자리)
- **표시 위치**: 우상단에 내 닉네임, 좌측 사이드바에 다른 사용자 목록

### 커서 표시
- **내 커서**: 기본 브라우저 커서
- **다른 사용자 커서**: 반투명 원(직경 20px) + 닉네임 라벨
- **색상**: 사용자마다 고유 색상 자동 할당 (7가지 파스텔 톤)
- **페이드아웃**: 5초간 움직임 없으면 opacity 0으로 전환

### 충돌 알림
- **서버 응답 실패 시**: 화면 상단에 "변경사항을 저장하지 못했습니다" 토스트
- **삭제된 노드 수정 시**: "이 노드는 삭제되었습니다" 토스트
- **네트워크 끊김 시**: "연결이 끊겼습니다. 재연결 중..." 배너

### 로딩 상태
- **워크스페이스 로딩**: 중앙에 "워크스페이스를 불러오는 중..." 스피너
- **실시간 연결 중**: "실시간 협업 연결 중..." 상태 바
- **스냅샷 복원 중**: "스냅샷 복원 중... (최대 7일치 이벤트)" 프로그레스 바

## 🚫 제약사항

### 이 단계에서 제외되는 것
- ❌ 계정 시스템 (회원가입, 로그인)
- ❌ 영구 프로필 (닉네임은 세션 동안만 유지)
- ❌ 워크스페이스 소유권 (모든 사용자가 모든 권한)
- ❌ 권한 관리 (Owner/Editor/Viewer)
- ❌ 워크스페이스 공개/비공개 설정
- ❌ Undo/Redo (Phase 2에서 클라이언트 in-memory stack으로 구현)
- ❌ Time Travel (Phase 2에서 서버 스냅샷 활용)

### 기술적 제약
- 모든 워크스페이스가 공개되어 있음
- 모든 사용자가 모든 워크스페이스에 접근 가능
- 세션 ID는 localStorage에 저장 (브라우저 닫으면 손실)

## 📊 KPI

### 정량적 지표
- **operation 전송 지연**: < 100ms (디바운싱 제외)
- **Server Streaming 지연**: < 50ms
- **동시 사용자 수**: 최소 10명 동시 접속 지원
- **충돌 발생률**: < 1% (Last Write Wins로 자동 해결)
- **스냅샷 복원 시간**: < 3초 (7일치 이벤트 기준)

### 정성적 지표
- 5명이 동시에 노드를 편집하는 테스트
- "부드럽다", "즉시 반영된다"는 피드백 80% 이상
- "충돌이 없다", "커서가 유용하다"는 피드백 70% 이상
